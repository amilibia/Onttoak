<!DOCTYPE html>
<html lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Onddoen Aurreikuspena (10 egun)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    #map { height: 320px; margin: 1rem 0; }
    #chart-container { width: 100%; max-width: 900px; margin-top: 1rem; }
    #search-container { margin-top: .5rem; display:flex; gap:.5rem; align-items:center; }
    input[type="text"] { padding: .5rem .6rem; width: 260px; }
    button { padding: .5rem .75rem; cursor: pointer; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>Onddoen Aurreikuspena (10 egun)</h1>
  <div id="search-container">
    <input type="text" id="search" placeholder="Bilatu herria (adib. Donostia, Gasteiz, Iruña)">
    <button id="btn-search">Bilatu</button>
    <span class="muted">(Open‑Meteo geocoding erabiltzen da; ez du API gakorik behar)</span>
  </div>
  <div id="map"></div>
  <p><strong>Kokapena:</strong> <span id="location">Egin klik mapan edo bilatu herri bat.</span></p>
  <div id="chart-container">
    <canvas id="species-chart"></canvas>
  </div>

  <script>
    // === Parametro orokorrak ===
    const retrasos = { boletus: 3, lactarius: 2, amanita: 5, cantharellus: 7, russula: 3, macrolepiota: 4 };
    const sentikortasuna = { boletus: 1.0, lactarius: 0.9, amanita: 0.8, cantharellus: 0.95, russula: 0.85, macrolepiota: 0.9 };

    // === Leaflet mapa ===
    let marker = null;
    const map = L.map('map').setView([43.0, -2.6], 8);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    // === Chart.js ===
    const chart = new Chart(document.getElementById('species-chart'), {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: 'Espezie bakoitzaren aurreikuspena (hurrengo 10 egunetan)' } },
        scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } } }
      }
    });

    // === Laguntza‑funtzioak ===
    const round025 = v => Math.round(v * 4) / 4; // 0.25ºko sareta

    function setMarkerAndCenter(lat, lon) {
      if (!marker) marker = L.marker([lat, lon]).addTo(map); else marker.setLatLng([lat, lon]);
      map.setView([lat, lon], 10, { animate: true });
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function linMap(x, x1, x2, y1, y2){ if (x <= x1) return y1; if (x >= x2) return y2; return y1 + (y2 - y1) * (x - x1) / (x - x + x2 - x1); }

    function mycoDailyIndex(daily){
      // daily: {time[], temperature_2m_min[], temperature_2m_max[], precipitation_sum[], relative_humidity_2m_max[]}
      const n = daily.time.length;
      const base = Array(n).fill(0);
      // euri pilaketa (3 eguneko soma)
      const rain3 = Array(n).fill(0);
      for (let i=0;i<n;i++){
        const r0 = daily.precipitation_sum[i] || 0;
        const r1 = i>0 ? (daily.precipitation_sum[i-1] || 0) : 0;
        const r2 = i>1 ? (daily.precipitation_sum[i-2] || 0) : 0;
        rain3[i] = r0 + r1 + r2;
      }
      for (let i=0;i<n;i++){
        const tmin = daily.temperature_2m_min[i];
        const tmax = daily.temperature_2m_max[i];
        const tmean = (tmin + tmax)/2;
        const hum = (daily.relative_humidity_2m_max?.[i] ?? 60);
        const r3 = rain3[i];
        // Tenperatura egokitasuna: gaussian 15ºC inguruan (sigma ~7)
        const tempScore = 100 * Math.exp(-Math.pow((tmean - 15)/7, 2));
        // Hezetasuna: 55→0, 70→60, 85→100
        const humScore = hum <= 55 ? 0 : hum >= 85 ? 100 : ( (hum-55)/(85-55) )*100;
        // Euria (3d soma): 0→0, 10mm→70, 20mm→100 (leundu)
        const rainScore = r3 <= 1 ? 0 : r3 >= 20 ? 100 : (r3/20)*100;
        const idx = 0.45*tempScore + 0.35*humScore + 0.20*rainScore; // 0–100
        base[i] = clamp(idx, 0, 100);
      }
      return base;
    }

    function spreadBySpecies(base, delays, sensitivity){
      // oinarri‑indizea (eguneko) -> espezie bakoitzerako aurreikuspena (desfasatua + leundua)
      const n = base.length;
      const out = {};
      Object.keys(delays).forEach(esp => out[esp] = Array(n).fill(0));
      Object.entries(delays).forEach(([esp, d]) => {
        for (let i=0;i<n;i++){
          const j = i + d;
          if (j < n){
            // hazkunde leuna + persistencia (egun bateko atzerapena %40)
            const prev = j>0 ? out[esp][j-1]*0.4 : 0;
            out[esp][j] = clamp(prev + base[i]* (sensitivity[esp]||1.0) * 0.9, 0, 100);
          }
        }
      });
      return out;
    }

    function updateChart(time, speciesSeries){
      chart.data.labels = time;
      chart.data.datasets = Object.entries(speciesSeries).map(([esp, arr], k) => ({
        label: esp.charAt(0).toUpperCase() + esp.slice(1),
        data: arr.map(v => Math.round(clamp(v,0,100))),
        fill:false,
        borderWidth:2,
        tension:.25
      }));
      chart.update();
    }

    async function fetchWeather(lat, lon) {
      // Past 14 + next 10, CORS‑friendly
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
                + `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,relative_humidity_2m_max`
                + `&timezone=Europe%2FMadrid&past_days=14&forecast_days=10`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Open‑Meteo HTTP ' + res.status);
      const json = await res.json();
      if (!json.daily || !Array.isArray(json.daily.time)) throw new Error('Datu egiturarik ez');
      return json;
    }

    async function reverseGeocode(lat, lon) {
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=eu&count=1`;
        const res = await fetch(url); if (!res.ok) throw new Error('Geocoding error');
        const j = await res.json();
        if (j && j.results && j.results.length) {
          const r = j.results[0];
          const name = `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ' (' + r.country + ')' : ''}`;
          return name;
        }
      } catch (e) { /* fallback */ }
      return null;
    }

    async function obtenerPrediccion(latRaw, lonRaw, labelOverride=null) {
      const lat = round025(+latRaw), lon = round025(+lonRaw);
      setMarkerAndCenter(lat, lon);

      let label = labelOverride;
      if (!label){
        const rev = await reverseGeocode(lat, lon);
        label = rev || 'Ezezaguna';
      }
      document.getElementById('location').innerText = `${label} — (${lat.toFixed(3)}, ${lon.toFixed(3)})`;

      try {
        const weather = await fetchWeather(lat, lon);
        const base = mycoDailyIndex(weather.daily);
        const species = spreadBySpecies(base, retrasos, sentikortasuna);
        // Azken 10 egun etorkizuneko leihoa soilik erakutsi (past_days barne baitago)
        const time = weather.daily.time;
        const last10IdxStart = Math.max(0, time.length - 10);
        const time10 = time.slice(last10IdxStart);
        const species10 = {};
        Object.keys(species).forEach(esp => species10[esp] = species[esp].slice(last10IdxStart));
        updateChart(time10, species10);
      } catch (err) {
        console.error(err);
        alert('Ez dago datu meteorologikorik erabilgarri puntuan. Saiatu hurbileko herri batean.');
      }
    }

    // === Map klik ===
    map.on('click', e => obtenerPrediccion(e.latlng.lat, e.latlng.lng));

    // === Bilatzailea: Open‑Meteo geocoding (forward) ===
    document.getElementById('btn-search').addEventListener('click', buscarUbicacion);
    document.getElementById('search').addEventListener('keydown', ev => { if (ev.key === 'Enter') buscarUbicacion(); });
    async function buscarUbicacion() {
      const q = document.getElementById('search').value.trim(); if (!q) return;
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=eu`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Geocoding HTTP ' + res.status);
        const j = await res.json();
        if (!j.results || !j.results.length) { alert('Ez da kokapena aurkitu.'); return; }
        const r = j.results[0];
        const label = `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ' (' + r.country + ')' : ''}`;
        obtenerPrediccion(r.latitude, r.longitude, label);
      } catch (e) {
        console.error('Bilaketa errorea:', e);
        alert('Errorea bilaketan. Saiatu beste izen batekin (adib. Donostia/Gipuzkoa).');
      }
    }
  </script>
</body>
</html>
