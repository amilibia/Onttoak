<!DOCTYPE html>
<html lang="eu">
<head>
  <meta charset="UTF-8">
  <title>Onddoen Aurreikuspena (10 egun)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    #map { height: 320px; margin: 1rem 0; }
    #chart-container { width: 100%; max-width: 900px; margin-top: 1rem; }
    #search-container { margin-top: .5rem; display:flex; gap:.5rem; align-items:center; }
    input[type="text"] { padding: .5rem .6rem; width: 260px; }
    button { padding: .5rem .75rem; cursor: pointer; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>Onddoen Aurreikuspena (10 egun)</h1>
  <div id="search-container">
    <input type="text" id="search" placeholder="Bilatu herria (adib. Donostia, Gasteiz, Iruña)">
    <button id="btn-search">Bilatu</button>
    <span class="muted">(Open‑Meteo geocoding erabiltzen da; ez du API gakorik behar)</span>
  </div>
  <div id="map"></div>
  <p><strong>Kokapena:</strong> <span id="location">Egin klik mapan edo bilatu herri bat.</span></p>
  <div id="chart-container">
    <canvas id="species-chart"></canvas>
  </div>

  <script>
    // === Parametro orokorrak ===
    const retrasos = { boletus: 3, lactarius: 2, amanita: 5, cantharellus: 7, russula: 3, macrolepiota: 4 };

    // === Leaflet mapa ===
    let marker = null;
    const map = L.map('map').setView([43.0, -2.6], 8);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    // === Chart.js ===
    const chart = new Chart(document.getElementById('species-chart'), {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: 'Espezie bakoitzaren aurreikuspena (hurrengo 10 egunetan)' } },
        scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } } }
      }
    });

    // === Laguntza-funtzioak ===
    const round025 = v => Math.round(v * 4) / 4; // 0.25ºko sareta

    function setMarkerAndCenter(lat, lon) {
      if (!marker) marker = L.marker([lat, lon]).addTo(map); else marker.setLatLng([lat, lon]);
      map.setView([lat, lon], 9);
    }

    function updateChartWithWeather(weather) {
      const fechas = weather.daily.time;
      const datos = {}; Object.keys(retrasos).forEach(esp => datos[esp] = Array(fechas.length).fill(0));

      fechas.forEach((_, i) => {
        const tmin = weather.daily.temperature_2m_min[i];
        const tmax = weather.daily.temperature_2m_max[i];
        const lluvia = weather.daily.precipitation_sum[i];
        const humedad = weather.daily.relative_humidity_2m_max?.[i] ?? 60; // ⚠️ izen zuzena
        const favorable = (tmin >= 5 && tmax <= 25 && lluvia >= 2 && humedad >= 70);
        Object.entries(retrasos).forEach(([esp, retraso]) => {
          const idx = i + retraso; if (favorable && idx < fechas.length) datos[esp][idx] += 15;
        });
      });

      chart.data.labels = fechas;
      chart.data.datasets = Object.entries(datos).map(([esp, valores]) => ({
        label: esp.charAt(0).toUpperCase() + esp.slice(1), data: valores.map(v => Math.min(v,100)), fill:false, tension:.3
      }));
      chart.update();
    }

    async function fetchWeather(lat, lon) {
      // Past egunak + hurrengo 10: Open‑Meteo forecast + past_days (CORS ez da arazoa)
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
                + `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,relative_humidity_2m_max`
                + `&timezone=Europe%2FMadrid&past_days=14&forecast_days=10`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Open‑Meteo  erantzun okerra: ' + res.status);
      const json = await res.json();
      if (!json.daily || !Array.isArray(json.daily.time)) throw new Error('Datu egiturarik ez');
      return json;
    }

    async function reverseGeocode(lat, lon) {
      // Open‑Meteo geocoding reverse (CORS-friendly). If it fails, return coords text.
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=eu&count=1`;
        const res = await fetch(url); if (!res.ok) throw new Error('Geocoding error');
        const j = await res.json();
        if (j && j.results && j.results.length) {
          const r = j.results[0];
          return `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ' (' + r.country + ')' : ''}`;
        }
      } catch (e) { /* silent fallback */ }
      return `Koordenatuak: ${lat}, ${lon}`;
    }

    async function obtenerPrediccion(latRaw, lonRaw, labelOverride=null) {
      const lat = round025(+latRaw), lon = round025(+lonRaw);
      setMarkerAndCenter(lat, lon);
      const label = labelOverride || await reverseGeocode(lat, lon);
      document.getElementById('location').innerText = label;
      try {
        const weather = await fetchWeather(lat, lon);
        updateChartWithWeather(weather);
      } catch (err) {
        console.error(err);
        alert('Ez dago datu meteorologikorik erabilgarri puntuan. Saiatu hurbileko herri batean.');
      }
    }

    // === Map klik ===
    map.on('click', e => obtenerPrediccion(e.latlng.lat, e.latlng.lng));

    // === Bilatzailea: Open‑Meteo geocoding (forward) ===
    document.getElementById('btn-search').addEventListener('click', buscarUbicacion);
    document.getElementById('search').addEventListener('keydown', ev => { if (ev.key === 'Enter') buscarUbicacion(); });
    async function buscarUbicacion() {
      const q = document.getElementById('search').value.trim(); if (!q) return;
      try {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=eu`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Geocoding HTTP ' + res.status);
        const j = await res.json();
        if (!j.results || !j.results.length) { alert('Ez da kokapena aurkitu.'); return; }
        const r = j.results[0];
        const label = `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ' (' + r.country + ')' : ''}`;
        obtenerPrediccion(r.latitude, r.longitude, label);
      } catch (e) {
        console.error('Bilaketa errorea:', e);
        alert('Errorea bilaketan. Saiatu beste izen batekin (adib. Donostia/Gipuzkoa).');
      }
    }
  </script>
</body>
</html>
